import router from '@ohos.router';
// å¯¼å…¥æ‰€æœ‰æ¨¡åž‹ï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®
import { DeviceModel } from '../model/DeviceModel';
import { LightDevice } from '../model/LightDevice';
import { ACDevice } from '../model/ACDevice';
import { LockDevice } from '../model/LockDevice';
import { CameraDevice } from '../model/CameraDevice';

// ä¸¥æ ¼å®šä¹‰è·¯ç”±å‚æ•°æŽ¥å£ï¼Œä¿®å¤ 'any' å’Œ 'Object' é”™è¯¯
interface RouteParams {
  deviceId: string;
}

// ä¸¥æ ¼å®šä¹‰è®¾å¤‡æ•°æ®æŽ¥å£ï¼Œä¿®å¤æ•°ç»„å’Œå¯¹è±¡å­—é¢é‡é”™è¯¯
interface DeviceJson {
  id: string;
  name: string;
  type: 'light' | 'ac' | 'lock' | 'camera' | string;
}

@Entry
@Component
struct DeviceControl {
  @State device: DeviceModel | null = null;

  aboutToAppear() {
    // ä¿®å¤ 'any' å’Œ 'Object' é”™è¯¯ï¼šä½¿ç”¨æ˜¾å¼æŽ¥å£ç±»åž‹æŽ¥æ”¶å‚æ•°
    const params: RouteParams | null = router.getParams() as RouteParams | null;

    let deviceId: string = '';

    // ä¿®å¤ 'Object.keys()' é”™è¯¯ï¼šå› ä¸ºæˆ‘ä»¬å·²ç»ä¸¥æ ¼å®šä¹‰äº† RouteParams ä¸”è®¾å¤‡åˆ—è¡¨æ˜¯ç¡¬ç¼–ç çš„ï¼Œ
    // æˆ‘ä»¬ç›´æŽ¥å®‰å…¨åœ°æ£€æŸ¥ deviceId å±žæ€§æ˜¯å¦å­˜åœ¨ã€‚
    if (params && params.deviceId) {
      deviceId = params.deviceId;
    }

    // --- ç¡¬ç¼–ç æ•°æ® (ä¿®å¤ Array literals å’Œ Object literal é”™è¯¯) ---
    const MOCK_DATA: DeviceJson[] = [
      { id: "1", name: "å®¢åŽ…ç¯", type: "light" },
      { id: "2", name: "å§å®¤ç©ºè°ƒ", type: "ac" },
      { id: "3", name: "å‰é—¨é”", type: "lock" },
      { id: "4", name: "èµ°å»Šæ‘„åƒå¤´", type: "camera" }
    ];
    const data: DeviceJson[] = MOCK_DATA;
    // ---------------------------------------------

    if (deviceId) {
      const item: DeviceJson | undefined = data.find((d: DeviceJson) => d.id === deviceId);

      if (item) {
        switch (item.type) {
          case 'light':
            this.device = new LightDevice(item.id, item.name);
            break;
          case 'ac':
            this.device = new ACDevice(item.id, item.name);
            break;
          case 'lock':
            this.device = new LockDevice(item.id, item.name);
            break;
          case 'camera':
            this.device = new CameraDevice(item.id, item.name);
            break;
          default:
            this.device = new DeviceModel(item.id, item.name, item.type);
        }
      }
    }

    if (!this.device) {
      this.device = new LightDevice('default_001', 'é»˜è®¤è®¾å¤‡ (ç¯å…‰)');
    }
  }

  build() {
    Column() {
      // æ£€æŸ¥ this.device éžç©º
      if (this.device) {
        // ä½¿ç”¨éžç©ºæ–­è¨€ '!' ç¡®ä¿å±žæ€§è®¿é—®å®‰å…¨
        Text(this.device!.name)
          .fontSize(28)
          .margin({ top: 20, bottom: 20 })

        // --- ç¯å…‰æŽ§åˆ¶ ---
        if (this.device instanceof LightDevice) {
          Text('çŠ¶æ€: ' + this.device!.status.toUpperCase())
          Toggle({ type: ToggleType.Switch, isOn: this.device!.status === 'on' })
            .onChange(() => {
              if (this.device) {
                this.device!.toggleStatus();
              }
            })
            .margin(10)

          Text('äº®åº¦: ' + (this.device as LightDevice)!.brightness + '%')
          Slider({ value: (this.device as LightDevice)!.brightness, min: 0, max: 100 })
            .onChange((value: number) => {
              (this.device as LightDevice)!.setBrightness(value);
            })
            .width('80%')
            .margin(10)

          // --- ç©ºè°ƒæŽ§åˆ¶ ---
        } else if (this.device instanceof ACDevice) {
          Text('çŠ¶æ€: ' + this.device!.status.toUpperCase())
          Toggle({ type: ToggleType.Switch, isOn: this.device!.status === 'on' })
            .onChange(() => {
              if (this.device) {
                this.device!.status = this.device!.status === 'on' ? 'off' : 'on';
              }
            })
            .margin(10)

          Text('æ¸©åº¦: ' + (this.device as ACDevice)!.temperature + 'Â°C')
            .margin({ top: 15 })
          Slider({ value: (this.device as ACDevice)!.temperature, min: 16, max: 30 })
            .onChange((value: number) => {
              (this.device as ACDevice)!.setTemperature(value);
            })
            .width('80%')
            .margin(10)

          // --- é—¨é”æŽ§åˆ¶ (å·²å¢žå¼º) ---
        } else if (this.device instanceof LockDevice) {
          // âš ï¸ ä¿®å¤ UI è¯­æ³•é”™è¯¯ï¼šå°† (this.device as LockDevice)! çš„æ–­è¨€å’Œéžç©ºæ“ä½œç›´æŽ¥å†™å…¥è¡¨è¾¾å¼ä¸­ï¼Œé¿å…ä½¿ç”¨ const è¯­å¥

          // 1. æ“æŽ§å¼€å…³ï¼šé—¨é”æ˜¯å¦åœ¨çº¿/é€šç”µ
          Text('è®¾å¤‡é€šç”µçŠ¶æ€: ' + (this.device as LockDevice)!.status.toUpperCase())
            .fontSize(20)
            .margin({ top: 10 })
          Toggle({ type: ToggleType.Switch, isOn: (this.device as LockDevice)!.status === 'on' })
            .onChange(() => {
              (this.device as LockDevice)!.toggleStatus();
            })
            .margin(10)

          // 2. æ ¸å¿ƒçŠ¶æ€ï¼šé”å®š/è§£é”
          Text('é—¨é”çŠ¶æ€: ' + ((this.device as LockDevice)!.isLocked ? 'ðŸ”’ å·²é”å®š' : 'ðŸ”“ å·²è§£é”'))
            .fontSize(24)
            .fontColor((this.device as LockDevice)!.isLocked ? Color.Red : Color.Green)
            .margin({ top: 20 })
          Button((this.device as LockDevice)!.isLocked ? 'è§£é”' : 'é”å®š')
            .type(ButtonType.Normal)
            .onClick(() => {
              (this.device as LockDevice)!.toggleLock();
            })
            .margin(15)
            .enabled((this.device as LockDevice)!.status === 'on')

          // 3. åˆ‡æ¢å®‰å…¨ç­‰çº§
          Text('å®‰å…¨ç­‰çº§: ' + (this.device as LockDevice)!.securityLevel)
            .fontSize(20)
            .margin({ top: 10 })
          Row() {
            Button('æ™®é€šæ¨¡å¼')
              .onClick(() => (this.device as LockDevice)!.setSecurityLevel('Normal'))
              .enabled((this.device as LockDevice)!.status === 'on')
              .backgroundColor((this.device as LockDevice)!.securityLevel === 'Normal' ? Color.Blue : Color.Gray)

            Button('é«˜å®‰å…¨æ¨¡å¼')
              .onClick(() => (this.device as LockDevice)!.setSecurityLevel('High'))
              .enabled((this.device as LockDevice)!.status === 'on')
              .backgroundColor((this.device as LockDevice)!.securityLevel === 'High' ? Color.Blue : Color.Gray)
              .margin({ left: 10 })
          }
          .margin(10)

          // 4. è¿œç¨‹è®¿é—®å¼€å…³
          Text('è¿œç¨‹è®¿é—®: ' + ((this.device as LockDevice)!.remoteAccessEnabled ? 'âœ… å¼€å¯' : 'âŒ å…³é—­'))
            .fontSize(20)
            .margin({ top: 10 })
          Toggle({ type: ToggleType.Switch, isOn: (this.device as LockDevice)!.remoteAccessEnabled })
            .onChange(() => {
              (this.device as LockDevice)!.toggleRemoteAccess();
            })
            .margin(10)
            .enabled((this.device as LockDevice)!.status === 'on')

          // 5. è­¦æŠ¥çŠ¶æ€æç¤º (ä¿®å¤å±žæ€§è®¿é—®é”™è¯¯)
          if ((this.device as LockDevice)!.alarm) {
            Text('ðŸš¨ è­¦æŠ¥ä¸­ï¼è¯·æ³¨æ„ï¼')
              .fontColor(Color.Red)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .margin(20)
          } else {
            Button('ðŸ“¢ æ¨¡æ‹Ÿè§¦å‘è­¦æŠ¥')
              .type(ButtonType.Normal)
              .onClick(() => {
                (this.device as LockDevice)!.triggerAlarm();
              })
              .margin(15)
              .enabled((this.device as LockDevice)!.status === 'on')
          }


          // --- æ™ºèƒ½æ‘„åƒå¤´æŽ§åˆ¶ ---
        } else if (this.device instanceof CameraDevice) {
          // âš ï¸ ä¿®å¤ UI è¯­æ³•é”™è¯¯ï¼šé¿å…ä½¿ç”¨ const è¯­å¥ï¼Œç›´æŽ¥åœ¨è¡¨è¾¾å¼ä¸­è¿›è¡Œç±»åž‹æ–­è¨€

          // 1. æ‘„åƒå¤´å¼€å…³
          Text('çŠ¶æ€: ' + (this.device as CameraDevice)!.status.toUpperCase())
            .fontSize(20)
            .margin({ top: 10 })
          Toggle({ type: ToggleType.Switch, isOn: (this.device as CameraDevice)!.status === 'on' })
            .onChange(() => {
              (this.device as CameraDevice)!.toggleStatus();
            })
            .margin(10)

          // 2. éšç§æ¨¡å¼å¼€å…³
          Text('éšç§æ¨¡å¼: ' + ((this.device as CameraDevice)!.privacyMode ? 'å¼€å¯' : 'å…³é—­'))
            .fontSize(20)
            .fontColor((this.device as CameraDevice)!.privacyMode ? Color.Red : Color.Green)
            .margin({ top: 10 })
          Toggle({ type: ToggleType.Switch, isOn: (this.device as CameraDevice)!.privacyMode })
            .onChange(() => {
              (this.device as CameraDevice)!.togglePrivacyMode();
            })
            .margin(10)

          // 3. å½•åƒå¼€å…³
          Text('å½•åƒ: ' + ((this.device as CameraDevice)!.isRecording ? 'è¿›è¡Œä¸­...' : 'å·²åœæ­¢'))
            .fontSize(20)
            .fontColor((this.device as CameraDevice)!.isRecording ? Color.Red : Color.Black)
            .margin({ top: 10 })
          Button((this.device as CameraDevice)!.isRecording ? 'ðŸ”´ åœæ­¢å½•åƒ' : 'å½•åƒ')
            .type(ButtonType.Normal)
            .backgroundColor((this.device as CameraDevice)!.isRecording ? Color.Red : Color.Blue)
            .onClick(() => {
              (this.device as CameraDevice)!.toggleRecording();
            })
            .margin(15)
            .enabled((this.device as CameraDevice)!.status === 'on' && !(this.device as CameraDevice)!.privacyMode)

          // 4. æ¨¡æ‹Ÿè­¦æŠ¥
          if ((this.device as CameraDevice)!.motionDetected) {
            Text('ðŸš¨ ç§»åŠ¨ä¾¦æµ‹è­¦æŠ¥ï¼')
              .fontColor(Color.Red)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .margin(20)
          } else {
            Button('ðŸ“¢ æ¨¡æ‹Ÿç§»åŠ¨ä¾¦æµ‹')
              .type(ButtonType.Normal)
              .onClick(() => {
                (this.device as CameraDevice)!.triggerMotionAlert();
              })
              .margin(15)
              .enabled((this.device as CameraDevice)!.status === 'on' && !(this.device as CameraDevice)!.privacyMode)
          }
        }

        // é»˜è®¤å›¾æ ‡æˆ–ç±»åž‹æ˜¾ç¤º
        if (this.device.type) {
          Image($r(`app.media.${this.device.type}_icon`))
            .width(64)
            .height(64)
            .margin({ top: 30 })
        }
      }

      Button('è¿”å›žè®¾å¤‡åˆ—è¡¨')
        .type(ButtonType.Normal)
        .onClick(() => {
          router.back();
        })
        .margin({ top: 30 })
    }
    .width('100%')
    .height('100%')
    .padding(15)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
}